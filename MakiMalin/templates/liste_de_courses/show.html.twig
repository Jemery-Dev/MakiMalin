{% extends 'base.html.twig' %}

{% block title %}
    {% if liste_de_courses %}
        {{ liste_de_courses.nom }}
    {% else %}
        New ListeDeCourses
    {% endif %}
{% endblock %}

{% block body %}
    {% if liste_de_courses %}
        <h1>{{ liste_de_courses.nom }}</h1>

        {% if liste_de_courses.courses|length > 0 %}
            <ul>
                {% for course in liste_de_courses.courses %}
                    <li>
                        Nom: {{ course.article.nom }}, 
                        Quantité: {{ course.quantite }}, 
                        Acheté: {% if course.achete %}Oui{% else %}Non{% endif %}
                        <form method="POST" action="{{ path('app_liste_de_courses_toggle_achete', {'id': liste_de_courses.id, 'courseId': course.id}) }}">
                            <button type="submit">{% if course.achete %}Untoggle{% else %}Toggle{% endif %} Acheté</button>
                            <input type="hidden" name="_token" value="{{ csrf_token('toggle_achete' ~ course.id) }}">
                        </form>
                        <p>Categories :
                            <ul>
                                {% for categorie in course.article.getCategories() %}
                                    <li>{{ categorie.getNom() }}</li>
                                {% endfor %}
                            </ul>
                        </p>
                        <form method="POST" action="{{ path('app_liste_de_courses_remove_course', {'id': liste_de_courses.id, 'courseId': course.id}) }}">
                            <input type="hidden" name="_method" value="DELETE">
                            <button type="submit">Supprimer la course</button>
                            <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ course.id) }}">
                        </form>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>Cette liste de courses est vide.</p>
        {% endif %}
    {% else %}
        {% set redirection_url = path('app_home') %}
        {% autoescape false %}
            <script>
                window.location.href = "{{ redirection_url }}";
            </script>
        {% endautoescape %}
    {% endif %}

    <h2>Ajouter des articles à la liste :</h2>
    {% if articles %}
        <ul>
            {% for article in articles %}
                <li>
                    Nom: {{ article.nom }}
                    <form method="POST" action="{{ path('app_liste_de_courses_add_article', {'id': liste_de_courses.id, 'articleId': article.id}) }}">
                        <label for="quantity{{ article.id }}">Quantité :</label>
                        <input type="number" id="quantity{{ article.id }}" name="quantity" value="1" min="1">
                        <button type="submit">Ajouter à la liste</button>
                        <input type="hidden" name="_token" value="{{ csrf_token('add_article' ~ article.id) }}">
                    </form>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>Aucun article trouvé.</p>
    {% endif %}

    <h2>Liste collaborative :</h2>
    {% if liste_collaborative %}
        <ul>
            {% for user in liste_collaborative.getUtilisateurs() %}
                <li>
                    Nom d'utilisateur: {{ user.getUsername() }}
                    <form method="POST" action="{{ path('app_liste_collaborative_remove_user', {'listeCollaborativeId': liste_collaborative.id, 'userId': user.getId()}) }}">
                        <button type="submit">Supprimer</button>
                        <input type="hidden" name="_token" value="{{ csrf_token('remove_user' ~ user.getId()) }}">
                    </form>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>Aucun utilisateur dans la liste collaborative.</p>
    {% endif %}

        <h2>Ajouter des utilisateurs à la liste collaborative :</h2>
        <form method="POST" action="{{ path('app_liste_collaborative_add_user', {'id': liste_collaborative.id}) }}">
            <input type="hidden" name="listeCollaborativeId" value="{{ liste_collaborative.id }}">
            
            <label for="userId">Sélectionner un utilisateur :</label>
            <select id="userId" name="utilisateur_id">
                {% for user in users %}
                    <option value="{{ user.getId() }}">{{ user.getUsername() }}</option>
                {% endfor %}
            </select>
            
            <button type="submit">Ajouter</button>
            <input type="hidden" name="_token" value="{{ csrf_token('add_user') }}">
        </form>
    
    <a href="{{ path('app_home') }}">Retour à la liste</a>
{% endblock %}
